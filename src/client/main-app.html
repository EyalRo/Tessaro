<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Tessaro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3rem 1.5rem;
      }

      .app-shell {
        width: min(960px, 100%);
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .card {
        padding: 2.75rem 2.25rem;
        background: rgba(15, 23, 42, 0.92);
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 30px 90px -25px rgba(15, 23, 42, 0.65);
      }

      .card h1 {
        margin-top: 0;
        margin-bottom: 0.25rem;
        font-size: clamp(2.4rem, 4vw, 3.3rem);
        letter-spacing: -0.04em;
      }

      .muted {
        color: rgba(226, 232, 240, 0.78);
        line-height: 1.6;
      }

      .actions {
        margin-top: 2.25rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      button {
        appearance: none;
        border: none;
        padding: 0.9rem 1.6rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 1rem;
        background: linear-gradient(135deg, #38bdf8, #22d3ee);
        color: #0f172a;
        cursor: pointer;
        transition: transform 150ms ease, box-shadow 150ms ease, opacity 150ms ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 32px -20px rgba(56, 189, 248, 0.9);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .ghost-button {
        background: rgba(30, 41, 59, 0.3);
        color: #bae6fd;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .ghost-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px -18px rgba(59, 130, 246, 0.7);
      }

      .status-line {
        min-height: 1.5rem;
        margin-top: 1rem;
        font-size: 0.95rem;
        color: rgba(248, 113, 113, 0.9);
      }

      .status-line.success {
        color: rgba(74, 222, 128, 0.9);
      }

      .status-line.error {
        color: rgba(248, 113, 113, 0.95);
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1.5rem;
      }

      .dashboard-header h1 {
        margin-bottom: 0.25rem;
      }

      .dashboard-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.12em;
        font-size: 0.8rem;
        color: rgba(125, 211, 252, 0.85);
        margin-bottom: 0.5rem;
      }

      .helper-text {
        margin-top: 1.5rem;
        font-size: 0.9rem;
      }

      a.helper-link {
        color: #38bdf8;
        text-decoration: none;
      }

      a.helper-link:hover {
        text-decoration: underline;
      }

      .organizations {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .organization-card {
        padding: 1.75rem;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.14);
      }

      .organization-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .organization-header h2 {
        margin: 0;
        font-size: 1.5rem;
        letter-spacing: -0.01em;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        background: rgba(100, 116, 139, 0.25);
        color: rgba(226, 232, 240, 0.9);
      }

      .badge--success {
        background: rgba(16, 185, 129, 0.25);
        color: rgba(134, 239, 172, 0.95);
      }

      .badge--warning {
        background: rgba(253, 224, 71, 0.25);
        color: rgba(253, 224, 71, 0.95);
      }

      .services-heading {
        margin-top: 1.6rem;
        margin-bottom: 0.9rem;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.85);
      }

      .services-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }

      .service-card {
        padding: 1.25rem;
        border-radius: 12px;
        background: rgba(30, 41, 59, 0.78);
        border: 1px solid rgba(148, 163, 184, 0.14);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 180px;
      }

      .service-card h4 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
      }

      .service-description {
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .service-actions {
        margin-top: auto;
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
      }

      .admin-actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .empty-state {
        padding: 1rem 0;
        color: rgba(148, 163, 184, 0.9);
        font-style: italic;
      }

      [hidden] {
        display: none !important;
      }

      @media (max-width: 640px) {
        body {
          padding: 2.5rem 1.25rem;
        }

        .card {
          padding: 2.5rem 1.7rem;
        }

        .dashboard-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .dashboard-actions {
          width: 100%;
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <section id="login-card" class="card">
        <h1>Welcome to Tessaro</h1>
        <p class="muted">
          Sign in to access your organization workspace and launch the services you rely on every day.
        </p>
        <div class="actions">
          <button id="login-button" type="button">Continue as Tessaro Admin</button>
        </div>
        <div id="login-status" class="status-line" role="status" aria-live="polite"></div>
        <p class="helper-text muted">
          Need to administer the entire platform?
          <a class="helper-link" href="/admin">Open the platform console</a>.
        </p>
      </section>
      <section id="dashboard-card" class="card" hidden>
        <div class="dashboard-header">
          <div>
            <div class="eyebrow">Organization workspace</div>
            <h1 id="dashboard-title">Hello, <span id="user-name"></span></h1>
            <p id="user-role" class="muted"></p>
          </div>
          <div class="dashboard-actions">
            <button id="logout-button" type="button" class="ghost-button">Sign out</button>
          </div>
        </div>
        <div id="dashboard-status" class="status-line" role="status" aria-live="polite"></div>
        <p id="dashboard-subtitle" class="muted">
          Open a service below to get started. Administrators can also manage their organization and provision services.
        </p>
        <div id="organizations-container" class="organizations"></div>
      </section>
    </div>
    <script>
      (() => {
        const loginCard = document.getElementById("login-card");
        const dashboardCard = document.getElementById("dashboard-card");
        const loginButton = document.getElementById("login-button");
        const logoutButton = document.getElementById("logout-button");
        const loginStatus = document.getElementById("login-status");
        const dashboardStatus = document.getElementById("dashboard-status");
        const userName = document.getElementById("user-name");
        const userRoleLine = document.getElementById("user-role");
        const organizationsContainer = document.getElementById("organizations-container");
        const state = { context: null };

        function updateStatus(element, message, kind = "info") {
          if (!element) {
            return;
          }

          element.textContent = message ?? "";
          element.classList.remove("success", "error");

          if (kind === "success") {
            element.classList.add("success");
          } else if (kind === "error") {
            element.classList.add("error");
          }
        }

        function toggleView(view) {
          if (view === "dashboard") {
            loginCard?.setAttribute("hidden", "");
            dashboardCard?.removeAttribute("hidden");
          } else {
            loginCard?.removeAttribute("hidden");
            dashboardCard?.setAttribute("hidden", "");
            if (loginButton) {
              loginButton.disabled = false;
            }
          }
        }

        function formatRole(role) {
          switch (role) {
            case "admin":
              return "Platform administrator";
            case "organization_admin":
              return "Organization administrator";
            default:
              return "Organization member";
          }
        }

        function badgeClassForStatus(status) {
          return status === "active" ? "badge badge--success" : "badge badge--warning";
        }

        function launchService(service) {
          updateStatus(dashboardStatus, `Launching ${service.name}...`, "info");
          window.location.href = `/services/${encodeURIComponent(service.id)}`;
        }

        function manageService(service) {
          updateStatus(dashboardStatus, `Opening management tools for ${service.name} in a new tab...`, "info");
          window.open(`/admin#service-${encodeURIComponent(service.id)}`, "_blank", "noopener");
        }

        function manageOrganization(organization) {
          updateStatus(dashboardStatus, `Opening ${organization.name} administration in a new tab...`, "info");
          window.open(`/admin#organization-${encodeURIComponent(organization.id)}`, "_blank", "noopener");
        }

        function createServiceCard(service, isAdmin) {
          const card = document.createElement("article");
          card.className = "service-card";

          const title = document.createElement("h4");
          title.textContent = service.name;
          card.appendChild(title);

          const badge = document.createElement("span");
          badge.className = badgeClassForStatus(service.status);
          badge.textContent = service.status;
          card.appendChild(badge);

          const description = document.createElement("p");
          description.className = "service-description muted";
          description.textContent = service.description ?? "No description provided yet.";
          card.appendChild(description);

          const actions = document.createElement("div");
          actions.className = "service-actions";

          const launchButton = document.createElement("button");
          launchButton.type = "button";
          launchButton.textContent = "Launch";
          launchButton.addEventListener("click", () => launchService(service));
          actions.appendChild(launchButton);

          if (isAdmin) {
            const manageButton = document.createElement("button");
            manageButton.type = "button";
            manageButton.className = "ghost-button";
            manageButton.textContent = "Manage";
            manageButton.addEventListener("click", () => manageService(service));
            actions.appendChild(manageButton);
          }

          card.appendChild(actions);
          return card;
        }

        function renderOrganizations(organizations) {
          if (!organizationsContainer) {
            return;
          }

          organizationsContainer.innerHTML = "";

          if (!organizations.length) {
            const empty = document.createElement("div");
            empty.className = "empty-state";
            empty.textContent = "Your account is not currently assigned to an organization.";
            organizationsContainer.appendChild(empty);
            return;
          }

          organizations.forEach((organization) => {
            const section = document.createElement("section");
            section.className = "organization-card";

            const header = document.createElement("div");
            header.className = "organization-header";

            const title = document.createElement("h2");
            title.textContent = organization.name;
            header.appendChild(title);

            const badge = document.createElement("span");
            badge.className = badgeClassForStatus(organization.status);
            badge.textContent = organization.status;
            header.appendChild(badge);

            section.appendChild(header);

            const plan = document.createElement("p");
            plan.className = "muted";
            plan.textContent = `Plan: ${organization.plan}`;
            section.appendChild(plan);

            if (organization.isAdmin) {
              const adminActions = document.createElement("div");
              adminActions.className = "admin-actions";

              const manageOrgButton = document.createElement("button");
              manageOrgButton.type = "button";
              manageOrgButton.className = "ghost-button";
              manageOrgButton.textContent = "Manage organization";
              manageOrgButton.addEventListener("click", () => manageOrganization(organization));
              adminActions.appendChild(manageOrgButton);

              section.appendChild(adminActions);
            }

            const servicesHeading = document.createElement("h3");
            servicesHeading.className = "services-heading";
            servicesHeading.textContent = "Services";
            section.appendChild(servicesHeading);

            if (organization.services.length === 0) {
              const emptyServices = document.createElement("p");
              emptyServices.className = "empty-state";
              emptyServices.textContent = "No services are provisioned yet.";
              section.appendChild(emptyServices);
            } else {
              const servicesGrid = document.createElement("div");
              servicesGrid.className = "services-grid";

              organization.services.forEach((service) => {
                servicesGrid.appendChild(createServiceCard(service, organization.isAdmin));
              });

              section.appendChild(servicesGrid);
            }

            organizationsContainer.appendChild(section);
          });
        }

        function renderDashboard(context) {
          state.context = context;

          if (userName) {
            userName.textContent = context.user.name;
          }

          if (userRoleLine) {
            userRoleLine.textContent = formatRole(context.user.role);
          }

          renderOrganizations(context.organizations);
          updateStatus(dashboardStatus, "You're signed in to your organization workspace.", "success");
          toggleView("dashboard");
        }

        async function loadContext() {
          try {
            const response = await fetch("/api/app/context", {
              method: "GET",
              credentials: "include",
            });

            if (response.status === 401) {
              toggleView("login");
              updateStatus(loginStatus, "Sign in to access your organization workspace.", "info");
              return false;
            }

            if (!response.ok) {
              throw new Error(`Context request failed with status ${response.status}`);
            }

            const data = await response.json();
            renderDashboard(data);
            return true;
          } catch (error) {
            console.error("Failed to load organization context", error);
            toggleView("login");
            updateStatus(
              loginStatus,
              "We could not load your organization workspace. Please try signing in again.",
              "error",
            );
            return false;
          }
        }

        async function handleLoginClick() {
          if (!loginButton) {
            return;
          }

          loginButton.disabled = true;
          updateStatus(loginStatus, "Signing you in to Tessaro...", "info");

          try {
            const response = await fetch("/api/auth/login", {
              method: "POST",
              headers: { "content-type": "application/json" },
              credentials: "include",
              body: JSON.stringify({}),
            });

            if (!response.ok) {
              throw new Error(`Login failed with status ${response.status}`);
            }

            updateStatus(loginStatus, "Signed in successfully.", "success");
            const loaded = await loadContext();
            if (!loaded && loginButton) {
              loginButton.disabled = false;
            }
          } catch (error) {
            console.error("Failed to login", error);
            updateStatus(
              loginStatus,
              "Unable to sign in automatically. Please try again.",
              "error",
            );
            if (loginButton) {
              loginButton.disabled = false;
            }
          }
        }

        async function handleLogoutClick() {
          if (!logoutButton) {
            return;
          }

          logoutButton.disabled = true;
          updateStatus(dashboardStatus, "Signing you out...", "info");

          try {
            await fetch("/api/auth/logout", {
              method: "POST",
              credentials: "include",
            });
          } catch (error) {
            console.warn("Failed to logout cleanly", error);
          }

          state.context = null;
          toggleView("login");
          updateStatus(loginStatus, "You're signed out. Sign in to get back to work.", "info");
          updateStatus(dashboardStatus, "");
          logoutButton.disabled = false;
        }

        loginButton?.addEventListener("click", handleLoginClick);
        logoutButton?.addEventListener("click", handleLogoutClick);

        loadContext();
      })();
    </script>
  </body>
</html>
